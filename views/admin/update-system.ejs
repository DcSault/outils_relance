<%- include('../partials/header') %>

<div class="container mt-4">
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow-sm">
                <div class="card-body d-flex justify-content-between align-items-center">
                    <div>
                        <h2 class="card-title">
                            <i class="fab fa-github me-2 text-dark"></i>Mise à jour du système
                        </h2>
                        <p class="card-text">Mettez à jour l'application depuis le dépôt GitHub.</p>
                    </div>
                    <a href="/admin/dashboard" class="btn btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>Retour au tableau de bord
                    </a>
                </div>
            </div>
        </div>
    </div>

    <% if (locals.updateStatus) { %>
        <div class="row mb-4">
            <div class="col-12">
                <div class="alert alert-<%= updateStatus.success ? (updateStatus.updated ? 'success' : 'info') : 'danger' %> alert-dismissible fade show" role="alert">
                    <h4 class="alert-heading">
                        <% if (updateStatus.success && updateStatus.updated) { %>
                            <i class="fas fa-check-circle me-2"></i>Mise à jour réussie
                        <% } else if (updateStatus.success && updateStatus.updatesAvailable) { %>
                            <i class="fas fa-exclamation-circle me-2"></i>Mises à jour disponibles
                        <% } else if (updateStatus.success) { %>
                            <i class="fas fa-info-circle me-2"></i>Information
                        <% } else { %>
                            <i class="fas fa-times-circle me-2"></i>Erreur
                        <% } %>
                    </h4>
                    <p><%= updateStatus.message %></p>
                    
                    <% if (updateStatus.success && updateStatus.updatesAvailable && updateStatus.commits && updateStatus.commits.length > 0) { %>
                        <div class="mt-3">
                            <h5>Commits disponibles :</h5>
                            <ul class="list-group">
                                <% updateStatus.commits.forEach(commit => { %>
                                    <li class="list-group-item"><%= commit %></li>
                                <% }); %>
                            </ul>
                        </div>
                        
                        <div class="mt-3">
                            <form action="/admin/apply-updates" method="POST">
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-download me-1"></i>Appliquer les mises à jour
                                </button>
                            </form>
                        </div>
                    <% } %>
                    
                    <% if (updateStatus.success && updateStatus.updated && updateStatus.backupDir) { %>
                        <div class="mt-3">
                            <p>Une sauvegarde des données a été créée avant la mise à jour :</p>
                            <code><%= updateStatus.backupDir %></code>
                            
                            <div class="mt-2">
                                <form action="/admin/restore-backup" method="POST">
                                    <input type="hidden" name="backupDir" value="<%= updateStatus.backupDir %>">
                                    <button type="submit" class="btn btn-warning">
                                        <i class="fas fa-undo me-1"></i>Restaurer la sauvegarde
                                    </button>
                                </form>
                            </div>
                        </div>
                        
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>Note :</strong> Le serveur va redémarrer automatiquement pour appliquer les changements.
                        </div>
                        
                        <% if (updateStatus.version) { %>
                        <div class="alert alert-success mt-3">
                            <i class="fas fa-tag me-2"></i>
                            <strong>Nouvelle version :</strong> <%= updateStatus.version %>
                        </div>
                        <% } %>
                    <% } %>
                    
                    <% if (updateStatus.details) { %>
                        <div class="mt-3">
                            <button class="btn btn-sm btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#detailsCollapse" aria-expanded="false" aria-controls="detailsCollapse">
                                Afficher les détails techniques
                            </button>
                            <div class="collapse mt-2" id="detailsCollapse">
                                <div class="card card-body">
                                    <pre class="mb-0"><code><%= updateStatus.details %></code></pre>
                                </div>
                            </div>
                        </div>
                    <% } %>
                    
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
    <% } %>

    <div class="row">
        <div class="col-md-8">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-sync me-2"></i>Mise à jour depuis GitHub</h5>
                </div>
                <div class="card-body">
                    <p>Cette fonctionnalité vous permet de mettre à jour l'application en récupérant les dernières modifications du dépôt GitHub.</p>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Dépôt GitHub :</strong> <a href="https://github.com/DcSault/outils_relance" target="_blank">https://github.com/DcSault/outils_relance</a>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Version actuelle :</strong> <%= locals.version || '1.0.0' %>
                    </div>
                    
                    <% /* Commenté pour éviter les erreurs
                    <% if (locals.updateInfo) { %>
                    <div class="alert alert-info">
                        <i class="fas fa-history me-2"></i>
                        <strong>Dernière mise à jour :</strong> <%= new Date(updateInfo.lastUpdate).toLocaleDateString('fr-FR') %>
                        <% if (updateInfo.updatedBy) { %>
                        <br><strong>Mise à jour par :</strong> <%= updateInfo.updatedBy %>
                        <% } %>
                    </div>
                    <% } %>
                    */ %>
                    
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Attention :</strong> Avant d'appliquer une mise à jour, assurez-vous que :
                        <ul class="mb-0 mt-2">
                            <li>Vous avez sauvegardé vos données importantes</li>
                            <li>Aucune modification locale importante n'a été effectuée</li>
                            <li>Le serveur n'est pas en cours d'utilisation intensive</li>
                        </ul>
                    </div>
                    
                    <form action="/admin/check-updates" method="POST" class="mt-4">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-search me-1"></i>Vérifier les mises à jour
                        </button>
                    </form>
                </div>
            </div>
        </div>
        
        <div class="col-md-4">
            <div class="card border-0 shadow-sm mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-history me-2"></i>Sauvegardes</h5>
                </div>
                <div class="card-body">
                    <p>Liste des sauvegardes créées lors des mises à jour précédentes.</p>
                    
                    <div id="backupsList" class="list-group mt-3">
                        <div class="text-center">
                            <div class="spinner-border text-primary" role="status">
                                <span class="visually-hidden">Chargement...</span>
                            </div>
                            <p class="mt-2">Chargement des sauvegardes...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Fonction pour charger la liste des sauvegardes
    function loadBackups() {
        fetch('/admin/list-backups')
            .then(response => response.json())
            .then(data => {
                const backupsList = document.getElementById('backupsList');
                
                if (data.success) {
                    if (data.backups.length === 0) {
                        backupsList.innerHTML = '<div class="alert alert-info">Aucune sauvegarde disponible</div>';
                    } else {
                        let html = '';
                        
                        data.backups.forEach(backup => {
                            const date = new Date(backup.date);
                            const formattedDate = date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
                            
                            html += `
                                <div class="list-group-item">
                                    <div class="d-flex w-100 justify-content-between">
                                        <h6 class="mb-1">${backup.name}</h6>
                                        <small>${formattedDate}</small>
                                    </div>
                                    <p class="mb-1">Fichiers : ${backup.files.length}</p>
                                    <form action="/admin/restore-backup" method="POST" class="mt-2">
                                        <input type="hidden" name="backupDir" value="${backup.path}">
                                        <button type="submit" class="btn btn-sm btn-warning">
                                            <i class="fas fa-undo me-1"></i>Restaurer
                                        </button>
                                    </form>
                                </div>
                            `;
                        });
                        
                        backupsList.innerHTML = html;
                    }
                } else {
                    backupsList.innerHTML = `<div class="alert alert-danger">Erreur : ${data.message}</div>`;
                }
            })
            .catch(error => {
                const backupsList = document.getElementById('backupsList');
                backupsList.innerHTML = `<div class="alert alert-danger">Erreur lors du chargement des sauvegardes : ${error.message}</div>`;
            });
    }
    
    // Charger les sauvegardes au chargement de la page
    document.addEventListener('DOMContentLoaded', loadBackups);
</script>

<%- include('../partials/footer') %> 